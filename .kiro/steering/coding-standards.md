---
inclusion: always
---

# 编码规范

## 项目架构原则

### MP3编码器实现标准
- **严格遵循 ref/shine 参考实现** - 这是一个MP3编码器项目，所有算法必须与 `ref/shine/` 目录下的C实现保持一致
- 查找表、常量、计算公式必须与shine源码完全对应
- 算法步骤和数据流应镜像shine的实现逻辑
- 数值精度要求与shine保持一致，特别是量化和MDCT计算

### Shine实现严格遵循规范
- **函数定义一致性**: 
  - 函数名必须与shine中对应函数保持一致（转换为Rust命名规范）
  - 参数类型、顺序、数量必须对应shine的函数签名
  - 返回值类型必须与shine保持语义一致
- **函数实现功能一致性**:
  - 算法逻辑必须逐行对应shine的C实现
  - 循环结构、条件判断、计算顺序完全一致
  - 不允许"优化"或"简化"shine的原始逻辑
- **变量和参数类型严格对应**:
  - C的`int`对应Rust的`i32`，`unsigned int`对应`u32`
  - C的`float`对应Rust的`f32`，`double`对应`f64`
  - 数组大小和索引范围必须与shine完全一致
- **常量定义方式一致**:
  - 实现与shine相同的宏定义（使用Rust的`const`或`macro_rules!`）
  - 常量值必须与shine源码中的值完全相同
  - 查找表必须与shine的表格逐个元素对应
- **代码逻辑严格一致**:
  - 位运算、移位操作必须与shine保持一致
  - 数学计算的精度和舍入方式必须相同
  - 错误处理和边界条件检查必须对应
- **函数调用顺序一致**:
  - 函数调用的先后顺序必须与shine保持一致
  - 数据处理的流水线顺序不能改变
  - 初始化和清理的时机必须对应

### 问题调试规范
- **优先查看 shine 原始实现** - 遇到算法问题时，第一时间查看 `ref/shine/src/lib/` 中对应的C语言实现
- **不要擅自调整算法** - 发现问题时不要凭经验修改，必须参考shine的具体实现逻辑
- **逐行对比实现** - 将Rust实现与C实现逐行对比，确保逻辑完全一致
- **保持数据结构对应** - 确保Rust的数据结构与C结构体在内存布局和访问模式上保持一致
- **验证边界条件** - 特别关注shine如何处理边界值、错误情况和特殊输入
- **强制性实现验证**:
  - 每个函数实现完成后，必须与shine源码逐行对比验证
  - 使用相同的测试数据验证输出结果完全一致
  - 发现差异时，优先修改Rust实现以匹配shine，而不是质疑shine的正确性
  - 记录所有与shine的对应关系，包括文件名、函数名、行号

### 模块组织架构
- **核心模块**: `bitstream`, `encoder`, `huffman`, `mdct`, `quantization`, `reservoir`, `subband`, `tables`
- **配置模块**: `config` - 编码参数和设置
- **错误处理**: `error` - 统一的错误类型定义
- 每个模块专注单一职责，文件大小控制在500行以内
- 模块间通过明确的接口通信，避免循环依赖

## 代码质量要求

### 编译和静态检查
- **零警告政策** - 使用 `getDiagnostics` 工具检查，必须修复所有编译警告
- 运行 `cargo clippy` 并修复所有建议
- 使用 `cargo check` 验证编译通过
- 代码提交前必须通过所有静态检查

### Rust代码风格
- **命名约定**:
  - 变量和函数: `snake_case`
  - 结构体和枚举: `PascalCase`
  - 常量: `SCREAMING_SNAKE_CASE`
  - 模块名: `snake_case`

### 错误处理模式
- 使用 `Result<T, E>` 进行错误传播
- 自定义错误类型在 `src/error.rs` 中定义
- 避免 `unwrap()` 和 `expect()`，除非在测试代码或已验证安全的情况下
- 错误信息应简洁明确，便于调试

### 文档和注释
- 所有公共API必须有 `///` 文档注释
- 复杂算法需要解释其在MP3编码中的作用
- 引用shine源码时注明对应文件和函数名
- 算法实现的关键步骤需要内联注释

## 开发工作流

### 代码修改流程
1. **查看shine源码** - 首先查看 `ref/shine/src/lib/` 中对应的C实现
2. **理解shine逻辑** - 完全理解shine的算法逻辑、数据流和函数调用关系
3. **使用 `getDiagnostics` 检查现有代码状态**
4. **严格按照shine实现** - 逐行对应地实现Rust版本
5. **进行修改后立即再次检查诊断信息**
6. **与shine输出对比验证** - 使用相同输入验证输出完全一致
7. **运行相关测试验证功能正确性**
8. **确保无编译警告和错误**

### 测试策略
- 每个算法模块都需要单元测试
- 关键算法需要与shine输出进行对比测试
- 使用 `proptest` 进行属性测试和边界条件验证
- 集成测试验证完整的编码流程

### 性能考虑
- MP3编码是计算密集型任务，优先考虑算法正确性
- 在保证正确性前提下优化性能热点
- 使用 `cargo bench` 进行性能基准测试
- 避免不必要的内存分配和拷贝

## Shine对应关系维护

### 文件对应关系
- 编码器主模块对应shine主编码流程文件
- 量化模块对应shine量化和循环文件
- MDCT模块对应shine MDCT变换文件
- 子带模块对应shine子带分析文件
- 比特流模块对应shine比特流文件
- Huffman模块对应shine Huffman编码文件
- 查找表模块对应shine查找表文件
- 比特池模块对应shine比特池文件

### 关键函数对应关系
必须严格维护以下函数的对应关系：
- shine编码主流程函数与Rust编码流程函数
- shine MDCT变换函数与Rust MDCT函数
- shine量化循环函数与Rust量化函数
- shine比特流处理函数与Rust比特流函数
- shine Huffman编码函数与Rust Huffman函数

### 数据结构对应关系
- shine全局配置结构与Rust编码器状态结构
- shine颗粒信息结构与Rust颗粒信息结构
- shine侧信息结构与Rust侧信息结构
- shine心理声学模型结构与Rust心理声学结构

### 常量和宏对应关系
- 颗粒大小常量必须与shine完全一致
- 频带限制常量必须与shine完全一致
- 标量因子带最大值必须与shine完全一致
- 所有查找表必须与shine完全一致

### 验证要求
- 每个函数实现后必须通过单元测试验证与shine输出一致
- 关键算法必须通过数值精度测试
- 完整编码流程必须与shine生成相同的MP3文件