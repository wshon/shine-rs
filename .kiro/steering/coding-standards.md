---
inclusion: always
---

# 编码规范

## 项目架构原则

### MP3编码器实现标准
- **严格遵循 ref/shine 参考实现** - 这是一个MP3编码器项目，所有算法必须与 `ref/shine/` 目录下的C实现保持一致
- 查找表、常量、计算公式必须与shine源码完全对应
- 算法步骤和数据流应镜像shine的实现逻辑
- 数值精度要求与shine保持一致，特别是量化和MDCT计算

### 问题调试规范
- **优先查看 shine 原始实现** - 遇到算法问题时，第一时间查看 `ref/shine/src/lib/` 中对应的C语言实现
- **不要擅自调整算法** - 发现问题时不要凭经验修改，必须参考shine的具体实现逻辑
- **逐行对比实现** - 将Rust实现与C实现逐行对比，确保逻辑完全一致
- **保持数据结构对应** - 确保Rust的数据结构与C结构体在内存布局和访问模式上保持一致
- **验证边界条件** - 特别关注shine如何处理边界值、错误情况和特殊输入

### 模块组织架构
- **核心模块**: `bitstream`, `encoder`, `huffman`, `mdct`, `quantization`, `reservoir`, `subband`, `tables`
- **配置模块**: `config` - 编码参数和设置
- **错误处理**: `error` - 统一的错误类型定义
- 每个模块专注单一职责，文件大小控制在500行以内
- 模块间通过明确的接口通信，避免循环依赖

## 代码质量要求

### 编译和静态检查
- **零警告政策** - 使用 `getDiagnostics` 工具检查，必须修复所有编译警告
- 运行 `cargo clippy` 并修复所有建议
- 使用 `cargo check` 验证编译通过
- 代码提交前必须通过所有静态检查

### Rust代码风格
- **命名约定**:
  - 变量和函数: `snake_case` (例: `encode_frame`, `bit_rate`)
  - 结构体和枚举: `PascalCase` (例: `Mp3Encoder`, `ChannelMode`)
  - 常量: `SCREAMING_SNAKE_CASE` (例: `MAX_BITRATE`, `FRAME_SIZE`)
  - 模块名: `snake_case`

### 错误处理模式
- 使用 `Result<T, E>` 进行错误传播
- 自定义错误类型在 `src/error.rs` 中定义
- 避免 `unwrap()` 和 `expect()`，除非在测试代码或已验证安全的情况下
- 错误信息应简洁明确，便于调试

### 文档和注释
- 所有公共API必须有 `///` 文档注释
- 复杂算法需要解释其在MP3编码中的作用
- 引用shine源码时注明对应文件和函数名
- 算法实现的关键步骤需要内联注释

## 开发工作流

### 代码修改流程
1. 使用 `getDiagnostics` 检查现有代码状态
2. 进行修改后立即再次检查诊断信息
3. 运行相关测试验证功能正确性
4. 确保无编译警告和错误

### 测试策略
- 每个算法模块都需要单元测试
- 关键算法需要与shine输出进行对比测试
- 使用 `proptest` 进行属性测试和边界条件验证
- 集成测试验证完整的编码流程

### 性能考虑
- MP3编码是计算密集型任务，优先考虑算法正确性
- 在保证正确性前提下优化性能热点
- 使用 `cargo bench` 进行性能基准测试
- 避免不必要的内存分配和拷贝