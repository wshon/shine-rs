# 需求文档

## 介绍

本项目旨在修复现有Rust MP3编码器中的关键音频数据编码问题。当前编码器能够生成MP3文件，但主数据区域几乎全是零，导致音频无法正常播放。这是一个严重的编码质量问题，需要系统性地调查和修复编码流水线中的关键环节。

## 术语表

- **Main_Data**: MP3帧中包含实际音频数据的主数据区域
- **Quantized_Coefficients**: 量化后的MDCT系数
- **Huffman_Encoded_Data**: 经过霍夫曼编码的音频数据
- **Bitstream_Writer**: 比特流写入器，负责将编码数据写入MP3帧
- **Quantization_Loop**: 量化循环，控制音频质量和比特率
- **MDCT_Coefficients**: 修正离散余弦变换系数
- **Big_Values**: MP3标准中的大值区域（频谱系数的主要部分）
- **Count1_Region**: MP3标准中的count1区域（高频系数部分）
- **Side_Info**: MP3帧的侧信息，包含解码所需的元数据
- **Bit_Reservoir**: 比特储备池，用于帧间比特分配

## 需求

### 需求 1: 音频数据完整性验证

**用户故事:** 作为开发者，我希望验证编码流水线中每个阶段的音频数据完整性，以便定位数据丢失的根本原因。

#### 验收标准

1. WHEN 输入非零PCM音频数据 THEN 子带滤波器输出 SHALL 包含非零系数
2. WHEN 子带滤波器输出非零系数 THEN MDCT变换输出 SHALL 包含非零频域系数
3. WHEN MDCT输出非零系数 THEN 量化循环 SHALL 产生非零量化系数
4. WHEN 量化系数非零 THEN 霍夫曼编码 SHALL 产生非零编码数据
5. WHEN 霍夫曼编码产生非零数据 THEN 比特流写入器 SHALL 将数据写入主数据区域

### 需求 2: 量化循环正确性

**用户故事:** 作为编码器，我需要确保量化循环正确处理MDCT系数，以便保留音频信息而不是将所有系数量化为零。

#### 验收标准

1. WHEN 接收到非零MDCT系数 THEN 量化循环 SHALL 使用适当的量化步长
2. WHEN 量化步长过大导致所有系数为零 THEN 量化循环 SHALL 减小量化步长
3. THE 量化循环 SHALL 确保至少保留部分非零系数以维持音频内容
4. WHEN 计算全局增益 THEN 量化循环 SHALL 使用与shine库一致的算法
5. THE 量化循环 SHALL 正确设置big_values和count1区域边界

### 需求 3: 霍夫曼编码数据完整性

**用户故事:** 作为编码器，我需要确保霍夫曼编码器正确编码量化系数，以便生成有效的音频数据。

#### 验收标准

1. WHEN 接收非零量化系数 THEN 霍夫曼编码器 SHALL 生成相应的编码比特
2. THE 霍夫曼编码器 SHALL 正确处理big_values区域的系数编码
3. THE 霍夫曼编码器 SHALL 正确处理count1区域的系数编码
4. WHEN 选择霍夫曼码表 THEN 编码器 SHALL 选择最适合的码表以最小化比特数
5. THE 霍夫曼编码器 SHALL 确保编码输出与shine库兼容

### 需求 4: 比特流主数据写入

**用户故事:** 作为编码器，我需要确保比特流写入器正确将霍夫曼编码数据写入MP3帧的主数据区域。

#### 验收标准

1. WHEN 接收霍夫曼编码数据 THEN 比特流写入器 SHALL 将数据写入主数据区域
2. THE 比特流写入器 SHALL 确保主数据区域不全为零
3. WHEN 写入主数据 THEN 比特流写入器 SHALL 正确处理比特对齐
4. THE 比特流写入器 SHALL 确保帧大小与配置的比特率匹配
5. WHEN 主数据不足填满帧 THEN 比特流写入器 SHALL 添加适当的填充

### 需求 5: 与参考实现的数值对比

**用户故事:** 作为开发者，我希望将编码流水线各阶段的输出与shine参考实现进行对比，以便识别差异和错误。

#### 验收标准

1. WHEN 使用相同输入数据 THEN 子带滤波器输出 SHALL 与shine库数值接近
2. WHEN 使用相同子带数据 THEN MDCT变换输出 SHALL 与shine库数值接近
3. WHEN 使用相同MDCT系数 THEN 量化输出 SHALL 与shine库数值接近
4. WHEN 使用相同量化系数 THEN 霍夫曼编码输出 SHALL 与shine库兼容
5. THE 最终MP3输出 SHALL 能被标准解码器正确解码

### 需求 6: 调试和诊断工具

**用户故事:** 作为开发者，我需要详细的调试工具来监控编码流水线各阶段的数据流，以便快速定位问题。

#### 验收标准

1. THE 调试工具 SHALL 提供每个编码阶段的数据转储功能
2. THE 调试工具 SHALL 显示量化系数的分布统计
3. THE 调试工具 SHALL 显示霍夫曼编码的比特使用情况
4. THE 调试工具 SHALL 提供与shine库的逐阶段数值对比
5. WHEN 检测到异常数据 THEN 调试工具 SHALL 发出警告并提供详细信息

### 需求 7: 边界条件和错误处理

**用户故事:** 作为编码器，我需要正确处理各种边界条件，确保在极端情况下仍能产生有效的音频数据。

#### 验收标准

1. WHEN 输入静音数据 THEN 编码器 SHALL 产生有效的静音MP3帧
2. WHEN 输入极低音量数据 THEN 编码器 SHALL 保留可检测的音频信号
3. WHEN 输入极高音量数据 THEN 编码器 SHALL 正确处理削波和量化
4. WHEN 比特率限制严格 THEN 编码器 SHALL 优雅降级而不是产生零数据
5. THE 编码器 SHALL 在所有情况下产生符合MP3标准的输出

### 需求 8: 性能和质量验证

**用户故事:** 作为用户，我希望修复后的编码器能够产生高质量的MP3文件，音频质量与shine库相当。

#### 验收标准

1. THE 修复后的编码器 SHALL 产生可被ffmpeg正确解码的MP3文件
2. THE 输出音频 SHALL 保持与输入音频相似的音量水平
3. THE 输出音频 SHALL 不包含明显的失真或噪音
4. WHEN 与shine库对比 THEN 音频质量 SHALL 达到可接受的相似度
5. THE 编码器 SHALL 通过标准MP3兼容性测试

### 需求 9: 回归测试和验证

**用户故事:** 作为开发者，我希望建立全面的测试套件，确保修复不会引入新的问题。

#### 验收标准

1. THE 测试套件 SHALL 包含多种音频类型的测试用例
2. THE 测试套件 SHALL 验证所有支持的采样率和比特率组合
3. THE 测试套件 SHALL 包含与shine库的输出对比测试
4. WHEN 修改编码器代码 THEN 所有回归测试 SHALL 继续通过
5. THE 测试套件 SHALL 自动检测音频数据丢失问题

### 需求 10: 文档和知识传递

**用户故事:** 作为维护者，我希望有详细的文档记录问题的根本原因和修复方案，以便未来的维护工作。

#### 验收标准

1. THE 文档 SHALL 详细记录问题的根本原因分析
2. THE 文档 SHALL 记录每个修复步骤和验证方法
3. THE 文档 SHALL 包含与shine库的关键差异说明
4. THE 文档 SHALL 提供故障排除指南
5. THE 文档 SHALL 包含性能基准和质量指标